app =					app.js

master-file-deploy =	deploy/views/layout.jade
master-css =			\    link(rel='stylesheet', href='/css/$(css-deploy-build)')
master-js =				\    script(src='/scripts/$(js-deploy-build)')

deploy-folder =			deploy/
public-folder =			public
views-folder =			views

css-path =				public/css/
css-deploy-path =		$(deploy-folder)$(css-path)
css-filename =			_styles.min.css
css-build =				$(css-path)$(css-filename)
css-prereq =			$(css-path)src/_styles.css \
						$(css-path)src/wfs.css \
						$(css-path)src/_media-queries.css


js-path =				public/scripts/
js-deploy-path =		$(deploy-folder)$(js-path)
js-filename =			_scripts.min.js
js-build =				$(js-path)$(js-filename)
js-build-map =			$(js-path)$(js-filename).map
js-prereq =				$(js-path)src/jquery.js \
						$(js-path)src/underscore.js \
						$(js-path)src/json2.js \
						$(js-path)src/_javascript.js \
						$(js-path)src/_fonts.js \
						$(js-path)src/_templates.js \
						$(js-path)src/backbone.js \
						$(js-path)src/_routes.js \
						$(js-path)src/_models-collections.js \
						$(js-path)src/_views.js

yui-jar =				build/tools/yuicompressor-2.4.5.jar
closure-jar =			build/tools/compiler.jar



all: $(css-build) $(js-build)

install: css-deploy-build = `cat $(css-build) | /usr/bin/openssl sha1 | cut -c1-8`.css
install: js-deploy-build = `cat $(js-build) | /usr/bin/openssl sha1 | cut -c1-8`.js
install: all
	@mkdir $(deploy-folder)
	@cp $(app) $(deploy-folder)
	@cp -R $(views-folder) $(deploy-folder)
	@cp -R $(public-folder) $(deploy-folder)
	@rm -rf $(deploy-folder)$(css-path)src
	@cp $(css-build) $(css-deploy-path)$(css-deploy-build)
	@cp $(js-build) $(js-deploy-path)$(js-deploy-build)
	@echo "Renaming js source map to match sha1 name\t\c"
	@mv $(js-deploy-path)$(js-filename).map $(js-deploy-path)$(js-deploy-build).map
	@echo "[ Done ]"
	@echo "Linking generated code to source map\t\t\c"
	@echo "//@ sourceMappingURL=$(js-deploy-build).map" >> $(js-deploy-path)$(js-deploy-build)
	@echo "[ Done ]"
	@echo "Linking to updated CSS and JavaScript…\t\t\c"
	@gsed -i "/\/\/ START: Concat css/,/\/\/ END: Concat css/c$(master-css)" $(master-file-deploy)
	@gsed -i "/\/\/ START: Concat scripts/,/\/\/ END: Concat scripts/c$(master-js)" $(master-file-deploy)
	@echo "[ Done ]"
	@echo "Installation is complete."

$(css-build): $(css-prereq)
	@rm -f $(css-build)
	@echo "Merging CSS files…\t\t\t\t\c"
	@cat $(css-prereq) > $(css-path)tmp.css
	@echo "[ Done ]"
	@echo "Compressing merged CSS…\t\t\t\t\c"
	@java -jar $(yui-jar) -o $(css-build) $(css-path)tmp.css
	@rm -f $(css-path)tmp.css
	@echo "[ Done ]"

$(js-build): $(js-prereq)
	@rm -f $(js-build) $(js-build-map)
	@echo "Merging JS files and generating source map…\t\c"
	@java -jar $(closure-jar) $(addprefix --js=,$^) >$@ --warning_level QUIET --create_source_map $(js-build).map --source_map_format=V3 --js_output_file $(js-build)
	@echo "Adjusting paths in source map…\t\c"
	@gsed -i "s/public\/scripts\/src/src/g" $(js-build).map
	@echo "[ Done ]"

clean:
	@rm -rf $(deploy-folder)
	@rm -f $(css-build)
	@rm -f $(js-build)